trigger:
- main

stages:
# ---------------- CI ----------------
- stage: CI
  displayName: Build & Push Docker Image
  jobs:
  - job: Build
    pool:
      name: VM-Pool
    steps:
    - task: Docker@2
      displayName: Build and Push Image
      inputs:
        containerRegistry: dockerhub-connection
        repository: ashishmondal420/azure-devops-live
        command: buildAndPush
        Dockerfile: app/Dockerfile
        tags: |
          latest
          $(Build.BuildId)

# ---------------- TEST ----------------
- stage: TEST
  displayName: Deploy to TEST
  dependsOn: CI
  jobs:
  - deployment: DeployTest
    displayName: Deploy to Test VM
    environment: test-vm
    pool:
      name: VM-Pool
    strategy:
      runOnce:
        deploy:
          steps:
          - script: |
              docker pull ashishmondal420/azure-devops-live:latest
              docker stop app || true
              docker rm app || true
              docker run -d -p 80:80 --name app ashishmondal420/azure-devops-live:latest
            displayName: Deploy to Test

# ---------------- PROD ----------------
- stage: PROD
  displayName: Deploy to PROD
  dependsOn: TEST
  jobs:
  - deployment: DeployProd
    displayName: Deploy to Prod VM
    environment: prod-vm   # ðŸ‘ˆ STRICT approval here
    pool:
      name: VM-Pool
    strategy:
      runOnce:
        deploy:
          steps:
          - script: |
              docker pull ashishmondal420/azure-devops-live:latest
              docker stop app || true
              docker rm app || true
              docker run -d -p 80:80 --name app ashishmondal420/azure-devops-live:latest
            displayName: Deploy to Prod
