trigger:
- main

variables:
  imageName: ashishmondal420/azure-devops-live

stages:

# =========================
# CI STAGE
# =========================
- stage: CI
  displayName: Build & Push Docker Image
  jobs:
  - job: Build
    displayName: CI - Docker Build
    pool:
      name: VM-Pool

    steps:
    # Fetch secrets from Azure Key Vault
    - task: AzureKeyVault@2
      displayName: Fetch secrets from Azure Key Vault
      inputs:
        azureSubscription: azure-kv-connection
        KeyVaultName: kv-azuredevops-live-test
        SecretsFilter: 'docker-username,docker-password'
        RunAsPreJob: true

    # Docker login using Key Vault secrets
    - script: |
        echo $(docker-password) | docker login -u $(docker-username) --password-stdin
      displayName: Docker Login (Key Vault)

    # Build & push Docker image
    - task: Docker@2
      displayName: Build and Push Docker Image
      inputs:
        command: buildAndPush
        repository: $(imageName)
        Dockerfile: app/Dockerfile
        tags: |
          latest
          $(Build.BuildId)

# =========================
# TEST STAGE
# =========================
- stage: TEST
  displayName: Deploy to TEST
  dependsOn: CI

  jobs:
  - deployment: DeployTest
    displayName: Deploy to Test VM
    environment: test-vm     # ðŸ‘ˆ Approval happens here
    pool:
      name: VM-Pool

    strategy:
      runOnce:
        deploy:
          steps:
          - script: |
              docker pull $(imageName):latest
              docker stop app || true
              docker rm app || true
              docker run -d -p 80:80 --name app $(imageName):latest
            displayName: Deploy container to TEST VM

# =========================
# PROD STAGE
# =========================
- stage: PROD
  displayName: Deploy to PROD
  dependsOn: TEST

  jobs:
  - deployment: DeployProd
    displayName: Deploy to Prod VM
    environment: prod-vm     # ðŸ‘ˆ STRONG approval here
    pool:
      name: VM-Pool

    strategy:
      runOnce:
        deploy:
          steps:
          - script: |
              docker pull $(imageName):latest
              docker stop app || true
              docker rm app || true
              docker run -d -p 80:80 --name app $(imageName):latest
            displayName: Deploy container to PROD VM
